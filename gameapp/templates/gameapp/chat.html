{% extends 'gameapp/base.html' %}
{% load static %}

{% block title %}Сообщения{% endblock %}

{% block footer %}{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow: hidden;
    }
    
    .container {
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
    
    .chat-container {
        height: calc(100vh - 56px);
        min-height: 500px;
        display: flex;
        border-radius: 0;
        overflow: hidden;
        box-shadow: none;
        margin: 0;
        background: white;
        position: relative;
        top: 25px;
    }
    
    .conversations-list {
        width: 350px;
        background-color: #f8fafc;
        border-right: 1px solid rgba(0, 0, 0, 0.05);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        cursor: pointer;
        transition: background-color 0.2s ease;
        position: relative;
    }
    
    .conversation-item:hover {
        background-color: rgba(67, 97, 238, 0.05);
    }
    
    .conversation-item.active {
        background-color: rgba(67, 97, 238, 0.1);
        border-left: 3px solid #4361ee;
        padding-left: 12px;
    }
    
    .conversation-item.unread {
        background-color: rgba(67, 97, 238, 0.03);
    }
    
    .conversations-header {
        padding: 15px 20px;
        background: #4361ee;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .conversations-header h5 {
        margin: 0;
        font-size: 1.1rem;
    }
    
    .chat-header {
        background: white;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-header .user-name {
        font-size: 1.1rem;
        font-weight: 600;
        margin-right: 5px;
        color: #333;
    }
    
    .chat-header .user-status {
        font-size: 0.85rem;
        color: #718096;
        margin-top: 2px;
    }
    
    .message-form {
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 15px;
        background: white;
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .message-input {
        border-radius: 20px;
        padding: 10px 15px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: #f8f9fa;
    }
    
    .message-submit {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #4361ee;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        cursor: pointer;
        border: none;
    }
    
    .messages-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8fafc;
        display: flex;
        flex-direction: column;
    }
    
    .message {
        max-width: 100%;
        margin-bottom: 5px;
        padding: 12px 18px;
        border-radius: 18px;
        position: relative;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
        white-space: normal;
        text-align: left;
        display: inline-block;
        min-width: 60px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-wrapper {
        max-width: 70%;
        margin-bottom: 10px;
    }
    
    .message-outgoing {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-bottom-right-radius: 5px;
        box-shadow: 0 2px 10px rgba(67, 97, 238, 0.15);
    }
    
    .message-incoming {
        background-color: white;
        color: #333;
        border-bottom-left-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .message-time {
        font-size: 0.75rem;
        margin-top: 5px;
        text-align: right;
        opacity: 0.8;
    }
    
    .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 15px;
        object-fit: cover;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .online-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
    }
    
    .online-true {
        background-color: #4cd137;
    }
    
    .online-false {
        background-color: #95a5a6;
    }
    
    .unread-badge {
        background-color: var(--warning-color);
        color: white;
        border-radius: 50%;
        min-width: 24px;
        height: 24px;
        padding: 0 5px;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #718096;
        padding: 30px;
        text-align: center;
    }
    
    .empty-state i {
        font-size: 5rem;
        margin-bottom: 1rem;
        opacity: 0.2;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    
    .conversation-meta {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        align-items: center;
    }
    
    .conversation-time {
        font-size: 0.75rem;
        color: #718096;
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        margin-top: 5px;
        font-size: 0.8rem;
        color: var(--primary-color);
    }
    
    .typing-indicator span {
        height: 5px;
        width: 5px;
        margin: 0 1px;
        background-color: var(--primary-color);
        border-radius: 50%;
        display: inline-block;
        animation: typing 1s infinite ease-in-out;
    }
    
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }
    
    /* Адаптивность для мобильных устройств */
    @media (max-width: 768px) {
        .chat-container {
            flex-direction: column;
            height: calc(100vh - 56px);
            top: 30px;
        }
        
        .conversations-list {
            width: 100%;
            height: 40%;
            max-height: 300px;
        }
        
        .chat-area {
            height: 60%;
        }
    }
    
    .conversation-item .d-flex {
        width: 100%;
    }
    
    .conversation-item .user-name {
        color: #333;
        font-weight: 600;
        font-size: 1rem;
    }
    
    .conversation-item p {
        color: #667085;
        margin-top: 2px;
    }
    
    .conversation-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
    {% endif %}
    
    <div class="chat-container">
        <!-- Список бесед -->
        <div class="conversations-list">
            <div class="conversations-header">
                <h5 class="mb-0">Ваши диалоги</h5>
                <div class="dropdown">
                    <button class="btn btn-sm text-white" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatOptionsDropdown">
                        <li><a class="dropdown-item" href="#" id="newChatBtn"><i class="fas fa-plus-circle me-2"></i>Новый чат</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-check-double me-2"></i>Отметить все как прочитанные</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-archive me-2"></i>Архивировать чаты</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Настройки</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="position-relative p-3">
                <i class="fas fa-search position-absolute" style="left: 20px; top: 50%; transform: translateY(-50%); color: #999;"></i>
                <input type="text" class="form-control px-4" placeholder="Поиск диалогов..." style="border-radius: 20px; padding-left: 35px;">
            </div>
            
            <div class="conversations-items">
                {% if conversations %}
                    {% for conversation in conversations %}
                    <div class="conversation-item {% if conversation.id|stringformat:'s' == active_conversation_id %}active{% endif %} {% if conversation.unread_count > 0 %}unread{% endif %}"
                         onclick="selectConversation('{{ conversation.id }}', event)"
                         data-user-id="{{ conversation.other_user.id }}">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex">
                                <div class="me-3">
                                    {% if conversation.other_user_profile.avatar %}
                                    <a href="{% url 'user_profile' conversation.other_user.username %}">
                                        <img src="{{ conversation.other_user_profile.avatar.url }}" alt="Avatar" class="user-avatar">
                                    </a>
                                    {% else %}
                                    <a href="{% url 'user_profile' conversation.other_user.username %}">
                                        <div class="user-avatar d-flex align-items-center justify-content-center bg-primary text-white">
                                            {{ conversation.other_user.username|first|upper }}
                                        </div>
                                    </a>
                                    {% endif %}
                                </div>
                                <div>
                                    <a href="{% url 'user_profile' conversation.other_user.username %}" class="text-decoration-none text-body">
                                        <strong class="user-name">{{ conversation.other_user.username }}</strong>
                                    </a>

                                    <div class="text-muted small user-status-indicator">
                                        <span class="status-dot {% if conversation.other_user_profile.online_status %}active{% endif %}"></span>
                                        {% if conversation.other_user_profile.online_status %}Онлайн{% else %}Был(а) в сети {{ conversation.other_user_profile.last_online|timesince }} назад{% endif %}
                                    </div>
                                    <div class="conversation-meta">
                                        <span class="conversation-time">
                                            {% if conversation.last_message %}
                                                {{ conversation.last_message.created_at|date:"H:i" }}
                                            {% else %}
                                                ---
                                            {% endif %}
                                        </span>
                                        {% if conversation.unread_count > 0 %}
                                            <span class="unread-badge">{{ conversation.unread_count }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h5>Нет активных диалогов</h5>
                        <p class="text-muted">Начните общение с продавцом через страницу предложения или создайте новый чат</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Область чата -->
        <div class="chat-area d-flex flex-column flex-grow-1">
            {% if active_conversation_id %}
                        <div id="messages-container" class="messages-container flex-grow-1">
                            <!-- Сообщения будут загружены через AJAX -->
                            <div id="messages-placeholder">
                                <div class="text-center my-3">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Загрузка...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h4>Выберите диалог</h4>
                    <p class="text-muted">Выберите диалог из списка слева или начните новый чат</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для создания нового чата -->
<div class="modal fade" id="newChatModal" tabindex="-1" aria-labelledby="newChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newChatModalLabel">Новый чат</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="searchUser" class="form-label">Найти пользователя</label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchUser" placeholder="Введите имя пользователя">
                    </div>
                </div>
                <div id="userSearchResults" class="mt-3">
                    <!-- Результаты поиска пользователей -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        console.log('[CHAT] DOM загружен, инициализация чата');
        
        {% if active_conversation_id %}
            console.log('[CHAT] Активный диалог ID: {{ active_conversation_id }}');
            // Небольшая задержка для корректной инициализации элементов
            setTimeout(function() {
                loadMessages('{{ active_conversation_id }}');
            }, 100);
            
            // Запускаем периодическое обновление статуса пользователей
            console.log('[CHAT] Запускаем периодическое обновление статуса пользователей');
            setInterval(updateUsersStatus, 30000); // Обновляем каждые 30 секунд
        {% else %}
            console.log('[CHAT] Нет активного диалога');
        {% endif %}
        
        // Функция для выбора диалога без перезагрузки страницы
        window.selectConversation = function(conversationId, event) {
            console.log(`[CHAT] Выбран диалог ID: ${conversationId}`);
            event.preventDefault();
            
            // Удаляем класс active у всех диалогов
            const conversations = document.querySelectorAll('.conversation-item');
            conversations.forEach(item => {
                item.classList.remove('active');
            });
            
            // Добавляем класс active выбранному диалогу
            event.currentTarget.classList.add('active');
            console.log('[CHAT] Обновлен активный класс диалога');
            
            // Скрываем сообщение "Выберите диалог"
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                emptyState.style.display = 'none';
                console.log('[CHAT] Скрыто сообщение "Выберите диалог"');
            }
            
            // Загружаем сообщения выбранного диалога
            loadMessages(conversationId);
            
            // Обновляем информацию о чате в верхней части
            updateChatHeader(conversationId);
            
            // Обновляем URL без перезагрузки страницы
            const newUrl = '{% url 'chat' %}?conversation_id=' + conversationId;
            history.pushState({conversationId: conversationId}, '', newUrl);
            console.log(`[CHAT] URL обновлен: ${newUrl}`);
            
            // Обновляем статус пользователя после смены диалога
            updateUsersStatus();
        };
        
        // Открытие модального окна для нового чата
        const newChatBtn = document.getElementById('newChatBtn');
        const newChatModalEl = document.getElementById('newChatModal');
        let newChatModal;
        
        if (newChatModalEl) {
            newChatModal = new bootstrap.Modal(newChatModalEl);
        }
        
        if (newChatBtn) {
            newChatBtn.addEventListener('click', function() {
                if (newChatModal) {
                    newChatModal.show();
                }
            });
        }
        
        // Отправка сообщения
        const messageForm = document.getElementById('message-form');
        if (messageForm) {
            messageForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const messageInput = document.getElementById('message-input');
                const message = messageInput.value.trim();
                
                if (message) {
                    sendMessage('{{ active_conversation_id }}', message);
                    messageInput.value = '';
                }
            });
        }
        
        // Поиск пользователей
        const searchUserInput = document.getElementById('searchUser');
        const userSearchResults = document.getElementById('userSearchResults');
        
        if (searchUserInput) {
            searchUserInput.addEventListener('input', function() {
                const query = this.value.trim();
                if (query.length >= 2) {
                    searchUsers(query);
                } else {
                    userSearchResults.innerHTML = '';
                }
            });
        }
        
        // Функция для загрузки сообщений
        function loadMessages(conversationId) {
            console.log(`[CHAT] Начало загрузки сообщений для диалога ID: ${conversationId}`);
            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer) {
                console.error('[CHAT] Ошибка: не найден контейнер для сообщений');
                return;
            }
            
            // Очищаем контейнер сообщений
            messagesContainer.innerHTML = `
                <div id="messages-placeholder">
                    <div class="text-center my-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Загрузка...</span>
                        </div>
                    </div>
                </div>
            `;
            console.log('[CHAT] Контейнер сообщений очищен, показан индикатор загрузки');
            
            // Скрываем сообщение "Выберите диалог"
            const emptyState = document.querySelector('.empty-state');
            if (emptyState) {
                emptyState.style.display = 'none';
                console.log('[CHAT] Скрыто сообщение "Выберите диалог"');
            }
            
            // Проверяем, есть ли форма для сообщений
            if (!document.getElementById('message-form')) {
                // Если формы нет, создаем форму для отправки сообщений
                const chatArea = document.querySelector('.chat-area');
                if (chatArea) {
                    const messageForm = document.createElement('form');
                    messageForm.id = 'message-form';
                    messageForm.className = 'message-form';
                    messageForm.innerHTML = `
                        {% csrf_token %}
                        <button type="button" class="btn btn-link text-decoration-none text-muted">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="btn btn-link text-decoration-none text-muted">
                            <i class="far fa-smile"></i>
                        </button>
                        <input type="text" id="message-input" class="form-control message-input flex-grow-1" placeholder="Введите сообщение...">
                        <button type="submit" class="message-submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    `;
                    chatArea.appendChild(messageForm);
                    
                    // Привязываем обработчик события к форме
                    messageForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const messageInput = document.getElementById('message-input');
                        const message = messageInput.value.trim();
                        
                        if (message) {
                            sendMessage(conversationId, message);
                            messageInput.value = '';
                        }
                    });
                    
                    console.log('[CHAT] Добавлена форма для отправки сообщений');
                }
            }
            
            // Запрашиваем сообщения с сервера
            console.log(`[CHAT] Отправка запроса на получение сообщений для диалога ID: ${conversationId}`);
            fetch(`{% url 'get_messages' conversation_id=0 %}`.replace('0', conversationId), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-Debug-Level': 'verbose'
                }
            })
            .then(response => {
                console.log('[CHAT] Получен ответ от сервера:', response.status);
                return response.json();
            })
            .then(data => {
                console.log(`[CHAT] Получены данные сообщений, количество: ${data.messages ? data.messages.length : 0}`);
                
                // Полностью очищаем контейнер сообщений перед добавлением новых
                messagesContainer.innerHTML = '';
                
                // Проверяем, есть ли сообщения
                if (!data.messages || data.messages.length === 0) {
                    console.log('[CHAT] Сообщений в диалоге нет, показываем уведомление');
                    // Если сообщений нет, показываем соответствующее уведомление
                    const noMessagesDiv = document.createElement('div');
                    noMessagesDiv.className = 'text-center my-5 py-5';
                    noMessagesDiv.innerHTML = `
                        <div class="empty-messages-container">
                            <div class="empty-messages-icon">
                                <i class="far fa-comment-dots"></i>
                                <i class="fas fa-plus"></i>
                            </div>
                            <h4 class="mt-4 mb-2 empty-messages-title">Нет сообщений</h4>
                            <p class="text-muted mb-4">Начните диалог, отправив первое сообщение</p>
                        </div>
                    `;
                    
                    messagesContainer.appendChild(noMessagesDiv);
                    console.log('[CHAT] Добавлено уведомление "Нет сообщений"');
                    
                    // Добавляем стили для нового дизайна
                    const style = document.createElement('style');
                    style.textContent = `
                        .empty-messages-container {
                            max-width: 400px;
                            margin: 0 auto;
                            padding: 1rem;
                            animation: fadeInUp 0.5s ease-out;
                        }
                        
                        .empty-messages-icon {
                            position: relative;
                            width: 80px;
                            height: 80px;
                            margin: 0 auto;
                            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-size: 2rem;
                            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
                        }
                        
                        .empty-messages-icon .fa-plus {
                            position: absolute;
                            bottom: 0;
                            right: 0;
                            background: #fff;
                            color: var(--primary-color);
                            border-radius: 50%;
                            padding: 5px;
                            font-size: 1rem;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                            border: 2px solid white;
                            animation: pulse 1.5s infinite;
                        }
                        
                        .empty-messages-title {
                            color: #333;
                            font-weight: 600;
                            margin-top: 1.5rem;
                        }
                        
                        @keyframes pulse {
                            0% { transform: scale(1); }
                            50% { transform: scale(1.1); }
                            100% { transform: scale(1); }
                        }
                        
                        @keyframes fadeInUp {
                            from {
                                opacity: 0;
                                transform: translateY(20px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                } else {
                    console.log(`[CHAT] Начало отображения ${data.messages.length} сообщений`);
                    // Отображаем сообщения
                    data.messages.forEach((message, index) => {
                        const isCurrentUser = message.sender_id === {{ request.user.id }};
                        console.log(`[CHAT] Обработка сообщения ${index+1}/${data.messages.length}, ID: ${message.id}, от текущего пользователя: ${isCurrentUser}`);
                        
                        // Создаем контейнер сообщения
                        const messageContainer = document.createElement('div');
                        messageContainer.className = 'd-flex';
                        messageContainer.style.justifyContent = isCurrentUser ? 'flex-end' : 'flex-start';
                        
                        // Создаем блок с сообщением и временем
                        const messageWrapper = document.createElement('div');
                        messageWrapper.className = 'message-wrapper';
                        
                        // Создаем блок сообщения
                        const messageElement = document.createElement('div');
                        messageElement.className = `message message-${isCurrentUser ? 'outgoing' : 'incoming'}`;
                        messageElement.textContent = message.content;
                        
                        // Создаем блок времени
                        const timeElement = document.createElement('div');
                        timeElement.className = 'message-time';
                        timeElement.textContent = formatMessageTime(message.created_at);
                        
                        // Собираем все вместе
                        messageWrapper.appendChild(messageElement);
                        messageWrapper.appendChild(timeElement);
                        messageContainer.appendChild(messageWrapper);
                        messagesContainer.appendChild(messageContainer);
                    });
                    
                    console.log('[CHAT] Все сообщения отображены, прокручиваем к последнему');
                    // Прокручиваем к последнему сообщению
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Отмечаем сообщения как прочитанные
                    console.log('[CHAT] Отмечаем сообщения как прочитанные');
                    markMessagesAsRead(conversationId);
                }
            })
            .catch(error => {
                console.error('[CHAT] Ошибка при загрузке сообщений:', error);
                messagesContainer.innerHTML = `
                    <div class="text-center my-5">
                        <div class="text-danger">
                            <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                            <h5>Ошибка при загрузке сообщений</h5>
                            <p>Пожалуйста, попробуйте обновить страницу</p>
                        </div>
                    </div>
                `;
            });
        }
        
        // Функция для отметки сообщений как прочитанных
        function markMessagesAsRead(conversationId) {
            console.log(`[CHAT] Начало отметки сообщений как прочитанных для диалога ID: ${conversationId}`);
            // Получаем непрочитанные сообщения для текущего диалога
            fetch(`{% url 'get_messages' conversation_id=0 %}`.replace('0', conversationId) + '?unread_only=true', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-Debug-Level': 'verbose'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(`[CHAT] Получено ${data.messages ? data.messages.length : 0} непрочитанных сообщений`);
                // Отмечаем каждое непрочитанное сообщение как прочитанное
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(message => {
                        if (!message.is_read && message.sender_id !== {{ request.user.id }}) {
                            console.log(`[CHAT] Отмечаем сообщение ID: ${message.id} как прочитанное`);
                            fetch(`{% url 'mark_message_read' message_id=0 %}`.replace('0', message.id), {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken'),
                                    'X-Debug-Level': 'verbose'
                                }
                            }).then(response => {
                                console.log(`[CHAT] Ответ сервера при отметке сообщения ID: ${message.id} статус: ${response.status}`);
                            }).catch(error => {
                                console.error(`[CHAT] Ошибка при отметке сообщения ID: ${message.id} как прочитанного:`, error);
                            });
                        } else {
                            console.log(`[CHAT] Сообщение ID: ${message.id} не требует отметки (уже прочитано или от текущего пользователя)`);
                        }
                    });
                } else {
                    console.log('[CHAT] Нет непрочитанных сообщений для отметки');
                }
            })
            .catch(error => {
                console.error('[CHAT] Ошибка при получении непрочитанных сообщений:', error);
            });
        }
        
        // Получение CSRF-токена из cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Функция для отправки сообщения
        function sendMessage(conversationId, message) {
            console.log(`[CHAT] Отправка сообщения в диалог ID: ${conversationId}, текст: "${message.substring(0, 30)}${message.length > 30 ? '...' : ''}"`);
            // Отправляем сообщение на сервер
            fetch(`{% url 'send_message' conversation_id=0 %}`.replace('0', conversationId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Debug-Level': 'verbose'
                },
                body: JSON.stringify({
                    content: message
                })
            })
            .then(response => {
                console.log('[CHAT] Получен ответ от сервера при отправке сообщения:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('[CHAT] Результат отправки сообщения:', data);
                if (data.success) {
                    console.log('[CHAT] Сообщение успешно отправлено, добавляем в интерфейс');
                    // Обновляем список сообщений после успешной отправки
                    const messagesContainer = document.getElementById('messages-container');
                    
                    const now = new Date();
                    const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    
                    // Создаем контейнер сообщения
                    const messageContainer = document.createElement('div');
                    messageContainer.className = 'd-flex';
                    messageContainer.style.justifyContent = 'flex-end';
                    
                    // Создаем блок с сообщением и временем
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = 'message-wrapper';
                    
                    // Создаем блок сообщения
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message message-outgoing';
                    messageElement.textContent = message;
                    
                    // Создаем блок времени
                    const timeElement = document.createElement('div');
                    timeElement.className = 'message-time';
                    timeElement.textContent = time;
                    
                    // Собираем все вместе
                    messageWrapper.appendChild(messageElement);
                    messageWrapper.appendChild(timeElement);
                    messageContainer.appendChild(messageWrapper);
                    messagesContainer.appendChild(messageContainer);
                    
                    // Прокручиваем к последнему сообщению
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    console.log('[CHAT] Сообщение добавлено в интерфейс и прокручено к нему');
                } else {
                    console.error('[CHAT] Ошибка при отправке сообщения:', data.error);
                    alert('Не удалось отправить сообщение. Пожалуйста, попробуйте еще раз.');
                }
            })
            .catch(error => {
                console.error('[CHAT] Ошибка при отправке сообщения:', error);
                alert('Не удалось отправить сообщение. Пожалуйста, попробуйте еще раз.');
            });
        }
        
        // Функция для поиска пользователей
        function searchUsers(query) {
            userSearchResults.innerHTML = `
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Поиск...</span>
                    </div>
                </div>
            `;
            
            // Запрашиваем пользователей с сервера
            fetch(`/api/users/search/?query=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                userSearchResults.innerHTML = '';
                
                if (data.users.length === 0) {
                    userSearchResults.innerHTML = `
                        <div class="text-center py-3">
                            <p class="text-muted">Пользователи не найдены</p>
                        </div>
                    `;
                    return;
                }
                
                // Отображаем результаты
                data.users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-search-item';
                    userItem.innerHTML = `
                        <div class="d-flex align-items-center p-2">
                            ${user.avatar_url ? 
                                `<img src="${user.avatar_url}" alt="Avatar" class="user-avatar">` : 
                                `<div class="user-avatar d-flex align-items-center justify-content-center bg-primary text-white">
                                ${user.username[0].toUpperCase()}
                                </div>`
                            }
                            <div class="ms-3">
                                <div class="fw-bold">${user.username}</div>
                                <div class="small text-muted">
                                    ${user.online_status ? 
                                        `<span class="online-indicator online-true"></span> Онлайн` : 
                                        `Был(а) в сети ${user.last_online}`
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                    
                    userItem.addEventListener('click', function() {
                        if (newChatModal) {
                            newChatModal.hide();
                        }
                        
                        // Создаем новый диалог с выбранным пользователем
                        createConversation(user.id);
                    });
                    
                    userSearchResults.appendChild(userItem);
                });
            })
            .catch(error => {
                console.error('Ошибка при поиске пользователей:', error);
                userSearchResults.innerHTML = `
                    <div class="text-center py-3">
                        <p class="text-danger">Ошибка при поиске. Пожалуйста, попробуйте еще раз.</p>
                    </div>
                `;
            });
        }
        
        // Функция для создания нового диалога
        function createConversation(userId) {
            fetch('{% url 'create_conversation' %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    user_id: userId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Переходим к новому диалогу
                    window.location.href = `{% url 'chat' %}?conversation_id=${data.conversation_id}`;
                } else {
                    console.error('Ошибка при создании диалога:', data.error);
                    alert('Не удалось создать диалог. Пожалуйста, попробуйте еще раз.');
                }
            })
            .catch(error => {
                console.error('Ошибка при создании диалога:', error);
                alert('Не удалось создать диалог. Пожалуйста, попробуйте еще раз.');
            });
        }
        
        // Функция для обновления заголовка чата
        function updateChatHeader(conversationId) {
            // В реальном приложении здесь будет запрос для получения данных пользователя
            // Для демонстрации используем данные существующих диалогов
            {% for conversation in conversations %}
            if ('{{ conversation.id }}' === conversationId) {
                const chatArea = document.querySelector('.chat-area');
                if (!chatArea) return;
                
                // Проверяем, есть ли уже заголовок чата
                let chatHeader = chatArea.querySelector('.chat-header');
                if (!chatHeader) {
                    // Если заголовка нет, создаем новый
                    chatHeader = document.createElement('div');
                    chatHeader.className = 'chat-header';
                    chatArea.prepend(chatHeader);
                }
                
                // Добавляем id пользователя к заголовку чата для обновления статуса
                chatHeader.setAttribute('data-user-id', '{{ conversation.other_user.id }}');
                
                // Создаем контент для заголовка с данными текущего пользователя
                chatHeader.innerHTML = `
                    <div class="d-flex align-items-center">
                        <a href="{% url 'user_profile' conversation.other_user.username %}" class="text-decoration-none me-2">
                            {% if conversation.other_user_profile.avatar %}
                                <img src="{{ conversation.other_user_profile.avatar.url }}" alt="Avatar" class="user-avatar">
                            {% else %}
                                <div class="user-avatar d-flex align-items-center justify-content-center bg-primary text-white">
                                    {{ conversation.other_user.username|first|upper }}
                                </div>
                            {% endif %}
                        </a>
                        <div>
                            <div class="d-flex align-items-center">
                                <a href="{% url 'user_profile' conversation.other_user.username %}" class="text-decoration-none text-body">
                                    <strong class="user-name">{{ conversation.other_user.username }}</strong>
                                </a>
                                <span class="online-indicator {% if conversation.other_user_profile.online_status %}online-true{% else %}online-false{% endif %}"></span>
                            </div>
                            <div class="user-status">
                                {% if conversation.other_user_profile.online_status %}
                                    Онлайн
                                {% else %}
                                    Был(а) в сети {{ conversation.other_user_profile.last_online|date:"d.m.Y H:i" }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="dropdown">
                        <button class="btn btn-sm btn-light rounded-circle" type="button" id="chatActionDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatActionDropdown">
                            <li><a class="dropdown-item" href="{% url 'user_profile' conversation.other_user.username %}"><i class="fas fa-user me-2"></i>Профиль</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-bell-slash me-2"></i>Отключить уведомления</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-search me-2"></i>Поиск в чате</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#"><i class="fas fa-ban me-2"></i>Заблокировать</a></li>
                        </ul>
                    </div>
                `;
                
                // Если нет формы для сообщений, добавляем ее
                if (!document.getElementById('message-form')) {
                    const messageForm = document.createElement('form');
                    messageForm.id = 'message-form';
                    messageForm.className = 'message-form';
                    messageForm.innerHTML = `
                        {% csrf_token %}
                        <button type="button" class="btn btn-link text-decoration-none text-muted">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button type="button" class="btn btn-link text-decoration-none text-muted">
                            <i class="far fa-smile"></i>
                        </button>
                        <input type="text" id="message-input" class="form-control message-input flex-grow-1" placeholder="Введите сообщение...">
                        <button type="submit" class="message-submit">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    `;
                    chatArea.appendChild(messageForm);
                    
                    // Привязываем обработчик события к форме
                    messageForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const messageInput = document.getElementById('message-input');
                        const message = messageInput.value.trim();
                        
                        if (message) {
                            sendMessage(conversationId, message);
                            messageInput.value = '';
                        }
                    });
                }
            }
            {% endfor %}
        }
        
        // Функция для периодической проверки статуса пользователей
        function updateUsersStatus() {
            console.log('[CHAT] Начало обновления статусов пользователей');
            fetch('{% url 'update_online_status' %}?action=heartbeat', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Debug-Level': 'verbose'
                }
            }).then(response => {
                console.log('[CHAT] Обновлен статус текущего пользователя:', response.status);
                // После обновления своего статуса, получаем статусы других пользователей
                return fetch('{% url 'get_users_status' %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json',
                        'X-Debug-Level': 'verbose'
                    }
                });
            }).then(response => {
                console.log('[CHAT] Получен ответ на запрос статусов пользователей:', response.status);
                return response.json();
            })
            .then(data => {
                console.log(`[CHAT] Получены данные о статусах ${data.users ? data.users.length : 0} пользователей`);
                // Обновляем статусы всех пользователей в списке диалогов
                if (data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        console.log(`[CHAT] Обновление статуса пользователя ID: ${user.id}, online: ${user.online_status}`);
                        updateUserStatus(user.id, user.online_status, user.last_online);
                    });
                }
            })
            .catch(error => console.error('[CHAT] Ошибка при обновлении статусов:', error));
        }
        
        // Функция для обновления статуса конкретного пользователя в интерфейсе
        function updateUserStatus(userId, isOnline, lastOnline) {
            // Обновляем индикаторы онлайн статуса для каждого диалога с этим пользователем
            document.querySelectorAll(`[data-user-id="${userId}"]`).forEach(element => {
                // Обновляем класс индикатора
                const indicator = element.querySelector('.online-indicator');
                if (indicator) {
                    if (isOnline) {
                        indicator.classList.remove('online-false');
                        indicator.classList.add('online-true');
                    } else {
                        indicator.classList.remove('online-true');
                        indicator.classList.add('online-false');
                    }
                }
                
                // Обновляем текст статуса
                const statusText = element.querySelector('.user-status');
                if (statusText) {
                    if (isOnline) {
                        statusText.textContent = 'Онлайн';
                    } else {
                        // Форматируем дату последнего входа
                        const lastOnlineDate = new Date(lastOnline);
                        const formattedDate = `${lastOnlineDate.getDate().toString().padStart(2, '0')}.${(lastOnlineDate.getMonth() + 1).toString().padStart(2, '0')}.${lastOnlineDate.getFullYear()} ${lastOnlineDate.getHours().toString().padStart(2, '0')}:${lastOnlineDate.getMinutes().toString().padStart(2, '0')}`;
                        statusText.textContent = `Был(а) в сети ${formattedDate}`;
                    }
                }
            });
            
            // Обновляем статус в заголовке активного чата
            const chatHeader = document.querySelector('.chat-header');
            if (chatHeader && chatHeader.getAttribute('data-user-id') === userId.toString()) {
                const headerIndicator = chatHeader.querySelector('.online-indicator');
                if (headerIndicator) {
                    if (isOnline) {
                        headerIndicator.classList.remove('online-false');
                        headerIndicator.classList.add('online-true');
                    } else {
                        headerIndicator.classList.remove('online-true');
                        headerIndicator.classList.add('online-false');
                    }
                }
                
                const headerStatus = chatHeader.querySelector('.user-status');
                if (headerStatus) {
                    if (isOnline) {
                        headerStatus.textContent = 'Онлайн';
                    } else {
                        const lastOnlineDate = new Date(lastOnline);
                        const formattedDate = `${lastOnlineDate.getDate().toString().padStart(2, '0')}.${(lastOnlineDate.getMonth() + 1).toString().padStart(2, '0')}.${lastOnlineDate.getFullYear()} ${lastOnlineDate.getHours().toString().padStart(2, '0')}:${lastOnlineDate.getMinutes().toString().padStart(2, '0')}`;
                        headerStatus.textContent = `Был(а) в сети ${formattedDate}`;
                    }
                }
            }
        }

        // Функция для форматирования времени сообщения
        function formatMessageTime(dateString) {
            // Преобразуем строку ISO в объект Date
            const date = new Date(dateString);
            // Форматируем время как ЧЧ:ММ
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // Отображение сообщений в интерфейсе
        function displayMessages(messages) {
            // Очищаем контейнер перед добавлением сообщений
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                // Если сообщений нет, показываем заглушку
                messagesContainer.innerHTML = `
                    <div class="text-center my-5">
                        <p class="text-muted">Нет сообщений в этом диалоге</p>
                        <p class="text-muted small">Напишите что-нибудь, чтобы начать общение</p>
                    </div>
                `;
                return;
            }
            
            // Перебираем сообщения и добавляем их в контейнер
            messages.forEach(function(message) {
                const isCurrentUser = message.sender_id === currentUserId;
                const messageContainer = document.createElement('div');
                messageContainer.className = 'd-flex';
                messageContainer.style.justifyContent = isCurrentUser ? 'flex-end' : 'flex-start';
                
                // Создаем контейнер для сообщения
                const messageWrapper = document.createElement('div');
                messageWrapper.className = 'message-wrapper';
                
                // Создаем блок сообщения
                const messageElement = document.createElement('div');
                messageElement.className = `message message-${isCurrentUser ? 'outgoing' : 'incoming'}`;
                messageElement.textContent = message.content;
                
                // Создаем блок времени
                const timeElement = document.createElement('div');
                timeElement.className = 'message-time';
                timeElement.textContent = formatMessageTime(message.created_at);
                
                // Собираем все вместе
                messageWrapper.appendChild(messageElement);
                messageWrapper.appendChild(timeElement);
                messageContainer.appendChild(messageWrapper);
                messagesContainer.appendChild(messageContainer);
            });
            
            // Прокручиваем к последнему сообщению
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    });
</script>
{% endblock %} 